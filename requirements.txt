import streamlit as st
import pandas as pd

# -----------------------------
# ê¸°ë³¸ UI
# -----------------------------
st.set_page_config(page_title="ğŸ… ì‚°íƒ€ í…ŒìŠ¤íŠ¸", page_icon="ğŸ…", layout="centered")

st.title("ğŸ…ì‚°íƒ€í´ë¡œìŠ¤ì˜ ì°©í•œ ì•„ì´ í…ŒìŠ¤íŠ¸")
st.markdown("---")
# -----------------------------
# BGM ì„¤ì •
#-----------------------------
st.markdown("""
<audio autoplay loop>
  <source src="BGM.mp3" type="audio/mpeg">
</audio>
""", unsafe_allow_html=True)

# ------------------------------
# ë°°ê²½ ì„¤ì •
# ------------------------------
st.set_page_config(page_title=":ì‚°íƒ€: ì‚°íƒ€ í…ŒìŠ¤íŠ¸", page_icon=":ì‚°íƒ€:", layout="centered")

# ------------------------------
# ë°°ê²½ ëˆˆ, ì»¬ëŸ¬ ì„¤ì •
# ------------------------------
st.markdown("""
<style>
/* ğŸŒ¨ ë°°ê²½ ìƒ‰ */
.stApp {
    background-color: #FAF3E8;
}

/* â„ï¸ ëˆˆ ì»¨í…Œì´ë„ˆ */
.snow {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 9999;
}

/* â„ï¸ ìì—°ìŠ¤ëŸ¬ìš´ ëˆˆ */
.snow span {
    position: absolute;
    top: -10vh;
    background: rgba(255,255,255,0.95);
    border-radius: 40% 60% 55% 45%;
    filter: blur(0.6px);
    animation: snow-fall linear infinite;
}

/* â„ï¸ ë–¨ì–´ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
@keyframes snow-fall {
    to { transform: translateY(120vh); }
}
</style>

<div class="snow">
  <span style="left:3%;  width:14px; height:10px; animation-duration:14s;"></span>
  <span style="left:8%;  width:10px; height:14px; animation-duration:18s;"></span>
  <span style="left:14%; width:12px; height:11px; animation-duration:16s;"></span>
  <span style="left:20%; width:15px; height:13px; animation-duration:19s;"></span>
  <span style="left:26%; width:11px; height:15px; animation-duration:17s;"></span>
  <span style="left:32%; width:13px; height:10px; animation-duration:15s;"></span>
  <span style="left:38%; width:16px; height:14px; animation-duration:20s;"></span>
  <span style="left:44%; width:12px; height:16px; animation-duration:18s;"></span>
  <span style="left:50%; width:14px; height:12px; animation-duration:16s;"></span>
  <span style="left:56%; width:10px; height:14px; animation-duration:17s;"></span>
  <span style="left:62%; width:15px; height:13px; animation-duration:19s;"></span>
  <span style="left:68%; width:11px; height:15px; animation-duration:18s;"></span>
  <span style="left:74%; width:13px; height:11px; animation-duration:16s;"></span>
  <span style="left:80%; width:16px; height:14px; animation-duration:20s;"></span>
  <span style="left:86%; width:12px; height:16px; animation-duration:18s;"></span>
  <span style="left:92%; width:14px; height:12px; animation-duration:17s;"></span>
  <span style="left:47%; width:9px;  height:13px; animation-duration:15s;"></span>
  <span style="left:61%; width:10px; height:12px; animation-duration:14s;"></span>
</div>
""", unsafe_allow_html=True)
# ------------------------------
# ìŠ¤íƒ€ì¼ ì„¤ì •
# ------------------------------
st.markdown("""
<style>
/* ì¤‘ì•™ ì •ë ¬ ìœ ì§€ + í­ í™•ì¥ */
div.block-container {
    max-width: 1100px;  /* ê¸°ì¡´ 720px â†’ 1100pxë¡œ í™•ì¥ */
    padding-left: 2rem;
    padding-right: 2rem;
}

/* í…ìŠ¤íŠ¸ ì¤‘ì•™ */
h1, h2, h3, h4, h5, h6, p, label {
    text-align: center;
}

/* âœ… ì´ë¯¸ì§€ ì¤‘ì•™ ì •ë ¬ (í•µì‹¬) */
div[data-testid="stImage"] {
    display: flex;
    justify-content: center;
}

div[data-testid="stImage"] img {
    max-width: 100%;
}
/* ê²°ê³¼ ì´ë¯¸ì§€ ì¤‘ì•™ ì •ë ¬ */
div[data-testid="stImage"] img {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
    height: auto;
}
            
/* âœ… ì…ë ¥ì°½ ì¤‘ì•™ ì •ë ¬ */
div[data-baseweb="input"] {
    display: flex;
    justify-content: center;
}
div[data-baseweb="input"] input {
    width: 640px;
    max-width: 100%;
    text-align: center;
}

/* âœ… ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ */
div[data-testid="stButton"] {
    display: flex;
    justify-content: center;
}

/* âœ… ë²„íŠ¼ ìì²´ */
div[data-testid="stButton"] > button {
    width: 640px;          /* â† í¬ê²Œ */
    max-width: 100%;
    padding: 0.8em 1.4em;
    margin: 8px 0;
    font-size: 18px;
    font-weight: 700;
    color: #FFFFFF;
    background-color: #1F6F43;
    border-radius: 14px;
    border: none;
}

/* hover */
div[data-testid="stButton"] > button:hover {
    background-color: #145A32;
}
</style>
""", unsafe_allow_html=True)

# -----------------------------
# ì—‘ì…€ ë°ì´í„° ë¡œë“œ
# -----------------------------
q_df = pd.read_excel("Santa_q.xlsx")
r_df = pd.read_excel("Santa_r.xlsx")

TOTAL_STAGE = len(q_df)

# -----------------------------
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# -----------------------------
st.session_state.setdefault("page", "main")
st.session_state.setdefault("name", "")
st.session_state.setdefault("stage", 0)
st.session_state.setdefault("score", 0)

# -----------------------------
# ë©”ì¸ í˜ì´ì§€
# -----------------------------
if st.session_state.page == "main":

    st.header("ì‚°íƒ€í´ë¡œìŠ¤ì˜ í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ ì„ ë¬¼ì„ ë°›ìœ¼ì„¸ìš”! ğŸ")

    _, c, _ = st.columns([1, 2, 1])
    with c:
        st.image("Santa.png", width=650)

    st.markdown("### ğŸ„ ì‚°íƒ€ê°€ ë¶€ë¥¼ ë‹¹ì‹ ì˜ ì´ë¦„ì€?")

    _, c, _ = st.columns([1, 2, 1])
    with c:
        name = st.text_input('')

    _, c, _ = st.columns([1, 2, 1])
    with c:
        if st.button("ğŸ í…ŒìŠ¤íŠ¸ ì‹œì‘"):
            if name.strip() == "":
                st.warning("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
            else:
                st.session_state.name = name
                st.session_state.page = "test"
                st.rerun()
# -----------------------------
# í…ŒìŠ¤íŠ¸ í˜ì´ì§€
# -----------------------------
elif st.session_state.page == "test":

    # âœ… ìŠ¤í…Œì´ì§€ ì¢…ë£Œ ì²´í¬ëŠ” ì—¬ê¸°ì„œë§Œ
    if st.session_state.stage >= TOTAL_STAGE:
        st.session_state.page = "result"
        st.rerun()
        st.stop()

    row = q_df.iloc[st.session_state.stage]

    st.markdown(f"## ğŸ„ ìŠ¤í…Œì´ì§€ {int(row['stage'])} Â· {row['title']}")

    if pd.notna(row["image"]):
        _, c, _ = st.columns([1, 2, 1])
        with c:
            st.image(row["image"], width=650)

    _, c, _ = st.columns([1, 2, 1])
    with c:
        if st.button(row["option1"], key=f"{st.session_state.stage}_1"):
            st.session_state.score += int(row["score1"])
            st.session_state.stage += 1
            st.rerun()

        if st.button(row["option2"], key=f"{st.session_state.stage}_2"):
            st.session_state.score += int(row["score2"])
            st.session_state.stage += 1
            st.rerun()

        if st.button(row["option3"], key=f"{st.session_state.stage}_3"):
            st.session_state.score += int(row["score3"])
            st.session_state.stage += 1
            st.rerun()

# ê²°ê³¼ í˜ì´ì§€
elif st.session_state.page == "result":

    score = st.session_state.score

    result_row = r_df[
        (r_df["min_score"] <= score) & (r_df["max_score"] >= score)
    ]

    if result_row.empty:
        st.error(f"ì ìˆ˜ {score}ì ì— í•´ë‹¹í•˜ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
        st.stop()

    result = result_row.iloc[0]
    name = st.session_state.name

    st.markdown(f"### â­ **{name}**ì€(ëŠ”) **{result['result_title']}**")
    st.markdown(f"### ì´ì : **{score}ì **")

    _, col, _ = st.columns([1, 2, 1])
    with col:
        st.image(result["result_image"], width=650)

    result_text = result["result_text"].replace("\n", "<br>")

    st.markdown(
    f"""
    <div style="text-align:center; line-height:1.5;">
        {result_text}
    </div>
    """,
    unsafe_allow_html=True
)

    # -------------------------------
    # ë‘ ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ ì»¬ëŸ¼ ì‚¬ìš©
    _, col, _ = st.columns([1, 2, 1])
    with col:
        # ì‚°íƒ€ ì„ ë¬¼ ë°›ê¸°
        if st.button("ğŸ ì‚°íƒ€ê°€ ì£¼ëŠ” ì„ ë¬¼ ë°›ê¸°"):
            import webbrowser   
            webbrowser.open_new_tab(result["link"])

        # ë‹¤ì‹œ í•˜ê¸°
        if st.button("ğŸ”„ ë‹¤ì‹œ í•˜ê¸°"):
            st.session_state.stage = 0
            st.session_state.score = 0
            st.session_state.page = "main"
            st.rerun()